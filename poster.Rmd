---
title: "Untitled"
author:
- name: Robert Day
  affiliation: Royal Perth Hospital
- name: Tegan Rourke
  affiliation: Sir Charles Gaidner Hospital
- name: Hilary
  affiliation: The Conference Company

date: "7/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# prologue

In 2013 EPSM came to Perth, and for various reasons members of the WA branch organised the abstract submissions, scheduling and production of the abstract book. Just like the old days. This gave us direct access to the submission data, so like good scientists we looked at the time series. What we saw was that the submitters 

 a) left their submission to the very last minute
 b) definitely expected a deadline extension

Has anything changed since then?

# modus

Just as all happy families are the same, so all happy data analyses are alike.
They all follow the tripartite path of the UG[^1^] syllogism:

  * munge
  * analyse
  * present
  
## raw data

The submission data from http://theconferencecompany.com were in an Excel&trade;
workbook with several sheets, formatted to their requirements.
These were saved as individual ```.csv``` files, named for the sheet name.
The first sheet had details of the EPSM 2019 abstracts, 
without dates but labelled in submission order.
This contained columns for the submitter, title etc. 
which were not saved to ```EPSM2019_subs.csv``` for privacy.

A second sheet listed the number of submissions per day for the EPSM meetings in Hobart 2017, Adelaide 2018 and Perth 2019.
Dates were given as days prior to the conference opening date, in order to be able to compare conferences with different dates across years.
The columns for date and submissions each day were saved as ```Registration.csv``` file, as was the complete sheet of abstract details.
Submissions from EPSM 2013 were already in a ```.csv``` file using calendar dates.
These were converted to days prior to allow comparison.

EPSM and AOCMP abstracts were not seperated in the spreadsheet,
so a list of ID numbers for AOCMP abstracts supplied separately by email was used to classify the abstracts.
This list was saved as a single column ``AOCMP_abstracts.csv`` file.

Finally, significant dates for each conference were gathered from emails and previous conference websites, making use of http://www.archive.org as needed, and saved in ```conf.dates.csv```.

## munge to canonical form

Data from the submission date sheet were split into seperate files to make it easier to extend this anaylsis in the future.
```{r split merged}
# Load needed libraries and set file locations
library(data.table)
library(stringr)
library(ggplot2)

raw_path <- "data-raw"
clean_path <- "data"

# Read the raw submissions to get a submission date for each abstract
MS <- fread(file.path(raw_path, "Registration.csv"))
# Filenames without spaces are safer. The Perth data is EPSM & AOCMP combined
setnames(MS, c("day_prior", "Hobart_2017", "Adelaide_2018", "Combined_2019"))
# Clean up the day_prior column, converting the digits before the first " "
MS[, day_prior := lapply(tstrsplit(day_prior, " ")[1], as.integer)]

# Write seperate files for each conference, to make future re-use easier
for (conf in names(MS)[-1]) { 
  cols  <- c("day_prior", conf)
  write.csv(na.omit(MS[, ..cols]), # only rows with values for this conf
            file = file.path(clean_path, paste0(conf, ".csv"))
            )
}
```

EPSM and AOCMP abstracts were seperated in a two stage process.
First the list of AOCMP ID numbers was used to label the abstract ID by conference.
A list of abstract dates was generated by replicating dates for days with multiple submissions.
This list was then be matched with the abstracts, which were in order of submission.
There were a few more abstract IDs than recieved submissions, all AOCMP submissions.
These were all assigned to the final date in the submissions list.

```{r munge}
AOCMP <- fread(file.path(raw_path, "AOCMP_abstracts.csv"))
setnames(AOCMP, "ID")
# Read the complete submission sheet
PER_19 <- fread(file.path(raw_path, "EPSM2019_subs.csv"))
setnames(PER_19, c("submitter", "city", "state", "country", "code", 
                "theme","sub_theme", "ID"))
# Start by labelling everything as EPSM
PER_19[, conference := "EPSM"]
# Re-label rows that match the AOCMP ID list
PER_19[AOCMP, conference := "AOCMP", on = "ID"]
# Expand submission days so get a day for each submitted abstract
sub_days <- MS[!is.na(Combined_2019), rep(day_prior, Combined_2019)]
# If not enough days, assume the rest were all on the last day
all_days <- c(sub_days, rep(last(sub_days), nrow(PER_19)-length(sub_days)))
# As the abstracts are in submission order, this will set the right day
PER_19[, day_prior := all_days]

# Write out seperate EPSM and AOCMP files (already have the combined one above)
write.csv(PER_19[conference == "EPSM", ],
          file = file.path(clean_path, "Perth_2019.csv")
          )
write.csv(PER_19[conference == "AOCMP", ],
          file = file.path(clean_path, "AOCMP_2019.csv")
          )
```

Load up the significant dates and convert them all to days-before-conference,
then rearrange to long format for easier plotting.
```{r convert dates}
events <- fread(file.path(raw_path, "conf.dates.csv"))
# make a conference column that matches the other tables
events[, conference := paste(city, year, sep = "_")]
# calculate how long each period was
days_allowed <- events[, .(initial  = as.integer(difftime(call, close)),
                           extended = as.integer(difftime(close, extended)),
                           waiting  = as.integer(difftime(extended, date))
                           ), 
                           by="conference,year,city"
                       ]
# Make conference an ordered factor so ggplot doesn't rearrange
days_allowed[, conference := factor(conference, levels = rev(conference))]
# convert to long for for plotting
days_long <- melt(days_allowed, 
                  measure.vars = c("initial", "extended", "waiting"), 
                  variable.name = "period",
                  value.name = "days"
                  )

# Use a colourblind friendly palette with grey
ggplot(days_long) + 
  aes(x = conference, y = days, fill = period) +
  geom_col(width = 0.5) +
  scale_fill_manual(name = "Submission\nPeriod",
                    breaks = c("initial", "extended"), 
                    values=c("#56B4E9", "#E69F00", NA)) +
  geom_hline(yintercept = 0, colour = "black") +
  geom_vline(xintercept = 3.5, linetype = 2, size = 0.1) +
  ylab("days before meeting") +
  theme(legend.position=c(.85, .8)) +
  coord_flip()

```

# analyse this

# show and tell

# why? just, why?

# sharing the blame
[^1^]: Expressed most clearly in the Underpants Gnome credo<br>
 1. collect underpants<br>
 2. ???<br>
 3. profit!
